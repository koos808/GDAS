
※ DARTS 코드 수정
===

### 1. `에러사항` : 버전에 맞지 않아 생기는 문제 

* 1) cuda() 함수의 `async=True` 옵션
        ```
        input = input.float().cuda(async=True)
                                    ^
        SyntaxError: invalid syntax
        Process finished with exit code 1
        ```
  * 수정 전 : `Variable(target, requires_grad=False).cuda(async=True)`
  * 수정 후 : `Variable(target, requires_grad=False).cuda(non_blocking=True)`

※ DARTS.pytorch1.1 코드 수정
===

* 1) `cd cnn && python test.py --auxiliary --model_path cifar10_model.pt` 실행시 에러
  * `CUDA_VISIBLE_DEVICES=0 python test.py --auxiliary --model_path ./pre_trained_weight/cifar10_model.pt`
    ```
      File "test.py", line 107, in <module>
        main()
      File "test.py", line 61, in main
        utils.load(model, args.model_path)
      File "/home1/jinmo/FinNasNet/darts.pytorch1.1-master/cnn/utils.py", line 106, in load
        model.load_state_dict(torch.load(model_path))
      File "/home/jinmo/anaconda3/envs/koos_10.1/lib/python3.6/site-packages/torch/nn/modules/module.py", line 83
    0, in load_state_dict
        self.__class__.__name__, "\n\t".join(error_msgs)))
    RuntimeError: Error(s) in loading state_dict for NetworkCIFAR:
    ```
  * `darts.pytorch1.1-master/cnn/utils.py", line 106`에 torch.load(model_path) -> torch.load(model_path, map_location='cuda:0')
  * map_location='cpu' 로 하거나 사용할 cuda gpu 번호를 넣어주기 map_location='cuda:0'
  * test.py에서는 cpu나 cuda:0이나 별차이 없는듯?


### RNN run
* `CUDA_VISIBLE_DEVICES=0 python test.py --model_path ./pre_trained_weight/ptb_model.pt`
  * error : RuntimeError: Attempting to deserialize object on CUDA device 1 but torch.cuda.device_count() is 1. Please use torch.load with map_location to map your storages to an existing device.
  * -> `model = torch.load(args.model_path)`-> `model = torch.load(args.model_path, map_location='cpu')`
  * map_location='cpu' 추가 



※ GDAS 코드 수정
===

* github brunch : https://github.com/csjunxu/GDAS

* gpu 54 server
  * linux
  * RTX 2080 ti
  * cuda 10.1, cudnn 7.6.4
  * pytorch 1.4 : `conda install pytorch==1.4.0 torchvision==0.5.0 cudatoolkit=10.1 -c pytorch`
  * python 3.6
  * cv2, graphviz : `pip install opencv-python graphviz`

* 실행
  * 경로 변경 : cd GDAS-master/
  * 

* 1) `TORCH_HOME` error
  * `UDA_VISIBLE_DEVICES=0 bash ./scripts-cnn/train-cifar.sh GDAS_FG cifar10 cut` -> `get Must set TORCH_HOME envoriment variable for data dir saving`
  * 해결 : `export TORCH_HOME="~/.torch"`

* 2) 특이사항 코드 변경 부분
  * config 파일에서 epoch 600 -> 200으로 변경
  * config 파일 경로 : GDAS-master/configs/config 파일


* training 방법
  * Train the searched CNN on CIFAR
    * CUDA_VISIBLE_DEVICES=0 bash ./scripts-cnn/train-cifar.sh GDAS_FG cifar10  cut
    * CUDA_VISIBLE_DEVICES=0 bash ./scripts-cnn/train-cifar.sh GDAS_F1 cifar10  cut
    * CUDA_VISIBLE_DEVICES=0 bash ./scripts-cnn/train-cifar.sh GDAS_V1 cifar100 cut
  * Train the searched CNN on ImageNet
    * CUDA_VISIBLE_DEVICES=0,1,2,3 bash ./scripts-cnn/train-imagenet.sh GDAS_F1 52 14 B128 -1
    * CUDA_VISIBLE_DEVICES=0,1,2,3 bash ./scripts-cnn/train-imagenet.sh GDAS_V1 50 14 B256 -1

* RNN의 경우
  * Train the searched RNN
    * CUDA_VISIBLE_DEVICES=0 bash ./scripts-rnn/train-PTB.sh DARTS_V1
    * CUDA_VISIBLE_DEVICES=0 bash ./scripts-rnn/train-PTB.sh DARTS_V2
    * CUDA_VISIBLE_DEVICES=0 bash ./scripts-rnn/train-PTB.sh GDAS
    * CUDA_VISIBLE_DEVICES=0 bash ./scripts-rnn/train-WT2.sh DARTS_V1
    * CUDA_VISIBLE_DEVICES=0 bash ./scripts-rnn/train-WT2.sh DARTS_V2
    * CUDA_VISIBLE_DEVICES=0 bash ./scripts-rnn/train-WT2.sh GDAS

* evaludation 방법
  * Evaluate a trained CNN model
    * CUDA_VISIBLE_DEVICES=0 python ./exps-cnn/evaluate.py --data_path  $TORCH_HOME/cifar.python --checkpoint ${checkpoint-path}
    * CUDA_VISIBLE_DEVICES=0 python ./exps-cnn/evaluate.py --data_path  $TORCH_HOME/ILSVRC2012 --checkpoint ${checkpoint-path}
    * CUDA_VISIBLE_DEVICES=0 python ./exps-cnn/evaluate.py --data_path  $TORCH_HOME/ILSVRC2012 --checkpoint GDAS-V1-C50-
  * 아래 코드 참조하면 됨
  * `CUDA_VISIBLE_DEVICES=0 python ./exps-cnn/evaluate.py --data_path /home/jinmo/.torch/cifar.python --checkpoint ./output/NAS-CNN/GDAS_F1-cifar10-cut-E250/seed-745-checkpoint-cifar10-model.pth`
  * cifar10 dataset의 경우 TORCH_HOME이 "~/.torch"안의 cifar.python 폴더안에 생성되어 있으므로 이 path를 사용하도록 해야한다.

* visualization
  * `vis-arch.py` code를 이용하는데 genotypes 에러가 났음 : KeyError: 'genotypes'
    * checkpoint의 dictionary key를 보니 `dict_keys(['epoch', 'args', 'state_dict', 'optimizer', 'scheduler', 'accuracies'])` 이였음. 즉, genotypes의 key가 없음.
    * './exps-cnn/train_uils.py'에서 108번째 줄에 `genotypes : genotypes` 추가함
    * vis-arch.py 60번째 줄 g.render(filename, view=False) -> g.render(filename, view=True)
    * 동작 코드 : `CUDA_VISIBLE_DEVICES=0 python ./exps-cnn/vis-arch.py --checkpoint ./output/NAS-CNN/GDAS_F1-cifar10-cut-E250/seed-3629-checkpoint-cifar10-model.pth`
      * -> save_dir은 `vis-arch.py` 파일 마지막에 지정해주기 때문에 따로 argument로 안넣어줘도 됨.
    * reduction cell 없는 경우 있는데 이때 error 발생 상관x
      * -> Reduction cell이 None이면 건너뛰는 예외처리 코드 추가해주면 좋을 듯.

  